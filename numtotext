-- Engine & execution settings
set hive.execution.engine=tez;
set hive.vectorized.execution.enabled=true;
set hive.vectorized.execution.reduce.enabled=true;

-- Memory and container settings
set hive.tez.container.size=8192;
set hive.tez.java.opts=-Xmx6144m;
set tez.runtime.io.sort.mb=1024;
set hive.exec.reducers.bytes.per.reducer=67108864;

-- Join and spill settings
set hive.auto.convert.join=false;
set hive.map.aggr=false;
set hive.optimize.skewjoin=false;

-- Misc safety settings
set hive.strict.checks.cartesian.product=false;
set hive.exec.dynamic.partition.mode=nonstrict;
set hive.exec.stagingdir=/tmp/hive-staging;

-- Optional: limit parallelism
set tez.am.resource.memory.mb=2048;
set tez.task.resource.memory.mb=4096;

-- Sanity check first - small batch
create table dpdm_curated_epdn.tmps_entities_resolution_match_debug as
select 
    entity_id as match_entity_id,
    mod(row_number() over (order by entity_id), 180) as match_partition_bucket,
    name as match_name,
    address as match_address,
    state as match_state,
    country as match_country,
    postal_code as match_postal_code
from dpdm_curated_epdn.tmp_entities
limit 10000;
